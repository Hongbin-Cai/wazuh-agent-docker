# A minimal Ubuntu base image
FROM phusion/baseimage:latest

# Set repositories
RUN apt-cache search gnupg2 && apt-get update && \
    apt-get install -y curl apt-transport-https lsb-release gnupg2 && \
    curl -s https://packages.wazuh.com/key/GPG-KEY-WAZUH | apt-key add - && \
    echo "deb https://packages.wazuh.com/3.x/apt/ stable main" | tee /etc/apt/sources.list.d/wazuh.list && \
    apt-get update && \
    # HARDCODED VARIABLE
    WAZUH_MANAGER_IP="*********" apt-get install -y wazuh-agent && \
    # apt-get install wazuh-agent && \
    # disable wazuh-agent update
    sed -i "s/^deb/#deb/" /etc/apt/sources.list.d/wazuh.list && \
    sed -i "s/udp/tcp/" /var/ossec/etc/ossec.conf && \
    apt-get update

# Copy init and entrypoint scripts
RUN mkdir /entrypoint-scripts
COPY script/entrypoint.sh /entrypoint.sh

# grant permission to scripts
RUN chmod 755 /entrypoint.sh

# Copy services
COPY script/wazuh-agent.runit.service /etc/service/wazuh-agent/run
RUN chmod +x /etc/service/wazuh-agent/run

ENTRYPOINT ["/entrypoint.sh"]
